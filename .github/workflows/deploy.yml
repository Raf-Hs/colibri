name: Deploy Simple BlueGreen

on:
  push:
    branches: ["PROD"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Build backend
      run: |
        cd colibri-backend
        npm install

    - name: Build frontend
      run: |
        cd colibri-frontend
        npm install
        npm run build

    - name: Package build
      run: |
        tar -czf deploy.tar.gz colibri-backend colibri-frontend/dist

    - name: Upload to VPS
      run: |
        scp -o StrictHostKeyChecking=no deploy.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/colibri/colibri-green/

    - name: Extract on VPS
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
        "cd /var/www/colibri/colibri-green && rm -rf colibri-backend colibri-frontend && tar -xzf deploy.tar.gz && rm deploy.tar.gz"

    - name: Switch to GREEN and restart
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
        "bash /var/www/colibri/app/deploy.sh green"
